import Head from 'next/head'
import Image from 'next/image'
import { useEffect, useContext } from 'react'
import Navbar from '../Components/Navbar'
import Todo from '../Components/Todo'
import { TodosContext } from '../contexts/TodosContext'
import{getSession} from '@auth0/nextjs-auth0'
import { table, minifyRecords } from './api/utils/Airtable'

import { useUser } from '@auth0/nextjs-auth0';
import TodoForm from '../Components/TodoForm'


const Home = ({ initialTodos }) =>
{
  const { todos, setTodos } = useContext(TodosContext)
  
  useEffect(() => {
    setTodos(initialTodos)
  }, [])

  console.log(`here ${ initialTodos }`)
  console.log(todos)

   const { user, error, isLoading } = useUser();

  // if (isLoading) return <div>Loading...</div>;
  // if (error) return <div>{error.message}</div>;

//   if (user) {
//    console.log(user)
//   } else {
//     console.log(user)
//  }
 

  
    return (
      <div>
       <Head>
        <title>Authenticated To-do App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
     
      </Head>
      
        <Navbar user= {user}/>
     {user && <main >
                 <TodoForm/>
          <ul>
            <h1 className="text-2xl text-center mb-4">My todos</h1>
            {user && <p>Hello {user.given_name}</p>}
         
        {todos && todos.map(todo =>(<Todo key={todo.id} todo={todo}/>))}
     
          </ul>
        </main>}
        {!user && <p>Please Login to manage your TODO</p>}
      </div>
    );
  
  
//   return (
//     <div>
//       User logged out!
//       <a href="/api/auth/login">Login</a>
//       </div>);
  // 
}

export default Home;
//this function runs even before loading the above markup

export async function getServerSideProps(context)
{
  const session = await getSession(context.req, context.res)
  console.log(session)

  let todos=[]
  try {
    if (session?.user) {
      todos = await table.select({
       filterByFormula:`userId ='${session?.user.sub}'`
     }).firstPage()
  
   }
    
  return {
    props: {
      initialTodos: minifyRecords(todos),
      todoUser: session?.user || null
    }
  }
  } catch (err) {
    console.error(err.message)
  }
 
}